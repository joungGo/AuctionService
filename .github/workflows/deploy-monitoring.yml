name: Monitoring Deploy To AWS

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for monitoring deployment'
        required: false
        type: string
        default: 'Manual monitoring deployment'

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: main  # Always deploy from main branch

      - name: Display deployment info
        run: |
          echo "ğŸš€ Deploying monitoring stack to production"
          echo "ğŸ“ Reason: ${{ github.event.inputs.reason }}"
          echo "ğŸŒ¿ Branch: main"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ¯ Target: ${{ secrets.MONITORING_EC2_HOST }}"
          echo "ğŸ“Š Monitoring Spring Boot: ${{ secrets.EC2_HOST }}:8080"

      - name: Generate Prometheus configuration
        id: prometheus-config
        run: |
          cat > prometheus-server.prod.yml << 'EOF'
          # Prometheus ìš´ì˜í™˜ê²½ ì„¤ì • íŒŒì¼
          global:
            scrape_interval: 15s
            evaluation_interval: 15s

          rule_files:
            - "hikaricp_alerts.yml"

          scrape_configs:
            # Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
            - job_name: 'auction-service-prod'
              static_configs:
                - targets: ['${{ secrets.EC2_HOST }}:8080']
                  labels:
                    application: 'auction-service'
                    environment: 'production'
                    instance: 'ec2-auction-service'
              metrics_path: '/actuator/prometheus'
              scrape_interval: 15s
              scrape_timeout: 10s

            # Prometheus ìì²´ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
                  labels:
                    application: 'prometheus'
                    environment: 'production'
              metrics_path: '/metrics'
              scrape_interval: 15s

            # Grafana ë©”íŠ¸ë¦­ ìˆ˜ì§‘ (ì„ íƒì‚¬í•­)
            - job_name: 'grafana'
              static_configs:
                - targets: ['grafana:3000']
                  labels:
                    application: 'grafana'
                    environment: 'production'
              metrics_path: '/metrics'
              scrape_interval: 30s
          EOF
          
          # ì„¤ì • íŒŒì¼ì„ base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ì¶œë ¥
          echo "prometheus-config=$(base64 -w 0 prometheus-server.prod.yml)" >> $GITHUB_OUTPUT

      - name: Generate Docker Compose configuration
        id: docker-compose-config
        run: |
          cat > docker-compose.prod.yml << 'EOF'
          version: '3.8'

          services:
            # Prometheus (ë©”íŠ¸ë¦­ ìˆ˜ì§‘)
            prometheus:
              image: prom/prometheus:latest
              container_name: auction-prometheus-prod
              restart: unless-stopped
              ports:
                - "9090:9090"
              volumes:
                - ./prometheus-server.prod.yml:/etc/prometheus/prometheus.yml
                - ./hikaricp_alerts.yml:/etc/prometheus/hikaricp_alerts.yml
                - prometheus_data:/prometheus
              command:
                - '--config.file=/etc/prometheus/prometheus.yml'
                - '--storage.tsdb.path=/prometheus'
                - '--web.console.libraries=/etc/prometheus/console_libraries'
                - '--web.console.templates=/etc/prometheus/consoles'
                - '--storage.tsdb.retention.time=${{ secrets.PROMETHEUS_RETENTION_DAYS }}d'
                - '--web.enable-lifecycle'
              networks:
                - monitoring-network
              healthcheck:
                test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
                interval: 30s
                timeout: 10s
                retries: 3

            # Grafana (ì‹œê°í™”)
            grafana:
              image: grafana/grafana:latest
              container_name: auction-grafana-prod
              restart: unless-stopped
              ports:
                - "3001:3000"
              environment:
                - GF_SECURITY_ADMIN_USER=admin
                - GF_SECURITY_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
                - GF_USERS_ALLOW_SIGN_UP=false
                - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
                - GF_SERVER_DOMAIN=bidflow.cloud
                - GF_SERVER_ROOT_URL=https://bidflow.cloud/grafana
              volumes:
                - ./grafana/provisioning:/etc/grafana/provisioning
                - grafana_data:/var/lib/grafana
              networks:
                - monitoring-network
              depends_on:
                - prometheus
              healthcheck:
                test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
                interval: 30s
                timeout: 10s
                retries: 3

          volumes:
            prometheus_data:
              driver: local
            grafana_data:
              driver: local

          networks:
            monitoring-network:
              driver: bridge
          EOF
          
          # ì„¤ì • íŒŒì¼ì„ base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ì¶œë ¥
          echo "docker-compose-config=$(base64 -w 0 docker-compose.prod.yml)" >> $GITHUB_OUTPUT

      - name: Generate HikariCP alerts configuration
        id: hikaricp-alerts
        run: |
          cat > hikaricp_alerts.yml << 'EOF'
          groups:
            - name: hikaricp_alerts
              rules:
                # ë†’ì€ ì»¤ë„¥ì…˜ í’€ ì‚¬ìš©ë¥  ê²½ê³ 
                - alert: HighHikariCPPoolUsage
                  expr: (hikaricp_connections_active / hikaricp_connections_max) * 100 > 80
                  for: 1m
                  labels:
                    severity: warning
                    application: auction-service
                  annotations:
                    summary: "ë†’ì€ HikariCP ì»¤ë„¥ì…˜ í’€ ì‚¬ìš©ë¥ "
                    description: "HikariCP ì»¤ë„¥ì…˜ í’€ ì‚¬ìš©ë¥ ì´ 80%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì‚¬ìš©ë¥ : {{ $value }}%"

                # ì‹¬ê°í•œ ì»¤ë„¥ì…˜ í’€ ì‚¬ìš©ë¥ 
                - alert: CriticalHikariCPPoolUsage
                  expr: (hikaricp_connections_active / hikaricp_connections_max) * 100 > 95
                  for: 30s
                  labels:
                    severity: critical
                    application: auction-service
                  annotations:
                    summary: "ì‹¬ê°í•œ HikariCP ì»¤ë„¥ì…˜ í’€ ì‚¬ìš©ë¥ "
                    description: "HikariCP ì»¤ë„¥ì…˜ í’€ ì‚¬ìš©ë¥ ì´ 95%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì‚¬ìš©ë¥ : {{ $value }}%"

                # ì»¤ë„¥ì…˜ íšë“ íƒ€ì„ì•„ì›ƒ
                - alert: HikariCPConnectionAcquireTimeout
                  expr: hikaricp_connections_acquire_seconds > 1
                  for: 1m
                  labels:
                    severity: warning
                    application: auction-service
                  annotations:
                    summary: "HikariCP ì»¤ë„¥ì…˜ íšë“ íƒ€ì„ì•„ì›ƒ"
                    description: "ì»¤ë„¥ì…˜ íšë“ ì‹œê°„ì´ 1ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì‹œê°„: {{ $value }}ì´ˆ"

                # ëŒ€ê¸° ì¤‘ì¸ ìŠ¤ë ˆë“œ ë°œìƒ
                - alert: HikariCPPendingThreads
                  expr: hikaricp_connections_pending > 0
                  for: 30s
                  labels:
                    severity: warning
                    application: auction-service
                  annotations:
                    summary: "HikariCP ëŒ€ê¸° ìŠ¤ë ˆë“œ ë°œìƒ"
                    description: "ì‚¬ìš© ê°€ëŠ¥í•œ ì»¤ë„¥ì…˜ì´ ì—†ì–´ ëŒ€ê¸° ì¤‘ì¸ ìŠ¤ë ˆë“œê°€ ìˆìŠµë‹ˆë‹¤. ëŒ€ê¸° ìŠ¤ë ˆë“œ ìˆ˜: {{ $value }}"

                # ìœ íœ´ ì»¤ë„¥ì…˜ ë¶€ì¡±
                - alert: LowHikariCPIdleConnections
                  expr: hikaricp_connections_idle < 2
                  for: 2m
                  labels:
                    severity: warning
                    application: auction-service
                  annotations:
                    summary: "HikariCP ìœ íœ´ ì»¤ë„¥ì…˜ ë¶€ì¡±"
                    description: "ìœ íœ´ ì»¤ë„¥ì…˜ì´ 2ê°œ ë¯¸ë§Œì…ë‹ˆë‹¤. í˜„ì¬ ìœ íœ´ ì»¤ë„¥ì…˜: {{ $value }}ê°œ"
          EOF
          
          # ì„¤ì • íŒŒì¼ì„ base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ì¶œë ¥
          echo "hikaricp-alerts-config=$(base64 -w 0 hikaricp_alerts.yml)" >> $GITHUB_OUTPUT

      - name: Generate Grafana datasource configuration
        id: grafana-datasource
        run: |
          mkdir -p grafana/provisioning/datasources
          cat > grafana/provisioning/datasources/prometheus-datasource.yml << 'EOF'
          apiVersion: 1

          datasources:
            - name: Prometheus
              type: prometheus
              access: proxy
              url: http://prometheus:9090
              jsonData:
                httpMethod: POST
                manageAlerts: true
                prometheusType: Prometheus
                prometheusVersion: 3.3.0
                cacheLevel: 'High'
                allowAsRecordingRulesTarget: true
                timeInterval: 10s
                incrementalQueryOverlapWindow: 10m
              editable: true
              readOnly: false
          EOF
          
          # ì„¤ì • íŒŒì¼ì„ base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ì¶œë ¥
          echo "grafana-datasource-config=$(base64 -w 0 grafana/provisioning/datasources/prometheus-datasource.yml)" >> $GITHUB_OUTPUT

      - name: Generate Grafana dashboard configuration
        id: grafana-dashboard
        run: |
          mkdir -p grafana/provisioning/dashboards
          cat > grafana/provisioning/dashboards/dashboard.yml << 'EOF'
          apiVersion: 1

          providers:
            - name: 'HikariCP Dashboards'
              folder: 'HikariCP Monitoring'
              type: file
              options:
                path: /etc/grafana/provisioning/dashboards
              disableDeletion: false
              editable: true
              updateIntervalSeconds: 30
          EOF
          
          # ì„¤ì • íŒŒì¼ì„ base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ì¶œë ¥
          echo "grafana-dashboard-config=$(base64 -w 0 grafana/provisioning/dashboards/dashboard.yml)" >> $GITHUB_OUTPUT

      - name: Deploy monitoring stack to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.MONITORING_EC2_HOST }}
          username: ${{ secrets.MONITORING_EC2_USER }}
          key: ${{ secrets.MONITORING_EC2_SSH_KEY }}
          port: 22
          script: |
            # 1. Docker ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y docker.io docker-compose curl wget
              sudo usermod -aG docker ubuntu
              sudo systemctl enable docker
              sudo systemctl start docker
            fi
            
            # 2. ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /opt/monitoring
            cd /opt/monitoring
            
            # 3. ì„¤ì • íŒŒì¼ ìƒì„±
            echo '${{ steps.prometheus-config.outputs.prometheus-config }}' | base64 -d > prometheus-server.prod.yml
            echo '${{ steps.docker-compose-config.outputs.docker-compose-config }}' | base64 -d > docker-compose.prod.yml
            echo '${{ steps.hikaricp-alerts.outputs.hikaricp-alerts-config }}' | base64 -d > hikaricp_alerts.yml
            
            # 4. Grafana ì„¤ì • ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p grafana/provisioning/datasources grafana/provisioning/dashboards
            
            # 5. Grafana ì„¤ì • íŒŒì¼ ìƒì„±
            echo '${{ steps.grafana-datasource.outputs.grafana-datasource-config }}' | base64 -d > grafana/provisioning/datasources/prometheus-datasource.yml
            echo '${{ steps.grafana-dashboard.outputs.grafana-dashboard-config }}' | base64 -d > grafana/provisioning/dashboards/dashboard.yml
            
            # 6. íŒŒì¼ ê¶Œí•œ ì„¤ì •
            sudo chown -R ubuntu:ubuntu /opt/monitoring
            chmod 644 prometheus-server.prod.yml docker-compose.prod.yml hikaricp_alerts.yml
            chmod -R 644 grafana/
            
            # 7. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            echo "Cleaning up existing containers..."
            sudo docker-compose -f docker-compose.prod.yml down --remove-orphans || true
            sudo docker system prune -f || true
            
            # 8. ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì‹œì‘
            echo "Starting monitoring stack..."
            sudo docker-compose -f docker-compose.prod.yml up -d
            
            # 9. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            echo "Waiting for services to start..."
            sleep 15
            
            # Prometheus ìƒíƒœ í™•ì¸
            if curl -f http://localhost:9090/-/healthy >/dev/null 2>&1; then
              echo "âœ… Prometheus is running"
            else
              echo "âŒ Prometheus failed to start"
              sudo docker-compose -f docker-compose.prod.yml logs prometheus
              exit 1
            fi
            
            # Grafana ìƒíƒœ í™•ì¸
            if curl -f http://localhost:3001/api/health >/dev/null 2>&1; then
              echo "âœ… Grafana is running"
            else
              echo "âŒ Grafana failed to start"
              sudo docker-compose -f docker-compose.prod.yml logs grafana
              exit 1
            fi
            
            # 10. Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”íŠ¸ë¦­ í™•ì¸
            echo "Checking Spring Boot application metrics..."
            if curl -f http://${{ secrets.EC2_HOST }}:8080/actuator/prometheus >/dev/null 2>&1; then
              echo "âœ… Spring Boot metrics are accessible"
            else
              echo "âš ï¸ Spring Boot application is not running or metrics not exposed"
              echo "Please ensure the Spring Boot application is running on ${{ secrets.EC2_HOST }}:8080"
            fi
            
            # 11. ë°©í™”ë²½ ì„¤ì • (ì„ íƒì‚¬í•­)
            echo "Configuring firewall..."
            sudo ufw allow 22/tcp || true
            sudo ufw allow from ${{ secrets.EC2_HOST }} to any port 9090 || true
            sudo ufw allow from ${{ secrets.EC2_HOST }} to any port 3001 || true
            sudo ufw --force enable || true
            
            echo "ğŸ‰ Monitoring stack deployment completed!"

      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying monitoring deployment..."
          
          # Prometheus ì ‘ê·¼ í™•ì¸
          if curl -f http://${{ secrets.MONITORING_EC2_HOST }}:9090/-/healthy >/dev/null 2>&1; then
            echo "âœ… Prometheus is accessible at http://${{ secrets.MONITORING_EC2_HOST }}:9090"
          else
            echo "âŒ Prometheus is not accessible"
            exit 1
          fi
          
          # Grafana ì ‘ê·¼ í™•ì¸
          if curl -f http://${{ secrets.MONITORING_EC2_HOST }}:3001/api/health >/dev/null 2>&1; then
            echo "âœ… Grafana is accessible at http://${{ secrets.MONITORING_EC2_HOST }}:3001"
          else
            echo "âŒ Grafana is not accessible"
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ Monitoring deployment verification completed!"
          echo ""
          echo "ğŸ“Š Access Information:"
          echo "  - Prometheus: http://${{ secrets.MONITORING_EC2_HOST }}:9090"
          echo "  - Grafana: http://${{ secrets.MONITORING_EC2_HOST }}:3001"
          echo "  - Grafana Login: admin / [configured password]"
          echo ""
          echo "ğŸ”§ Management Commands:"
          echo "  - Check status: ssh ${{ secrets.MONITORING_EC2_USER }}@${{ secrets.MONITORING_EC2_HOST }} 'cd /opt/monitoring && sudo docker-compose -f docker-compose.prod.yml ps'"
          echo "  - View logs: ssh ${{ secrets.MONITORING_EC2_USER }}@${{ secrets.MONITORING_EC2_HOST }} 'cd /opt/monitoring && sudo docker-compose -f docker-compose.prod.yml logs -f'"
          echo "  - Restart services: ssh ${{ secrets.MONITORING_EC2_USER }}@${{ secrets.MONITORING_EC2_HOST }} 'cd /opt/monitoring && sudo docker-compose -f docker-compose.prod.yml restart'"
          echo ""
          echo "âš ï¸ Security Notes:"
          echo "  1. Grafana password is set via GRAFANA_ADMIN_PASSWORD secret"
          echo "  2. Firewall is configured to allow access only from Spring Boot server"
          echo "  3. Consider setting up ALB for HTTPS access"

      - name: Deployment Summary
        run: |
          echo "ğŸ¯ Deployment Summary"
          echo "===================="
          echo "âœ… Monitoring stack deployed successfully"
          echo "ğŸ“Š Prometheus: http://${{ secrets.MONITORING_EC2_HOST }}:9090"
          echo "ğŸ“ˆ Grafana: http://${{ secrets.MONITORING_EC2_HOST }}:3001"
          echo "ğŸ” Monitoring: ${{ secrets.EC2_HOST }}:8080/actuator/prometheus"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ğŸ“ Reason: ${{ github.event.inputs.reason }}"
          echo "ğŸ• Deployed at: $(date -u)"
